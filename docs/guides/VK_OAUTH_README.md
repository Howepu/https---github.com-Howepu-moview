# VK OAuth Интеграция для MoviePortal Admin

## Описание

Система авторизации через ВКонтакте для админ-панели MoviePortal с повышенной безопасностью. **Важно**: любой пользователь НЕ может авторизоваться в админке через VK - доступ ограничен только существующими администраторами.

## Принцип работы

1. **Ограниченный доступ**: VK авторизация доступна только для уже существующих администраторов
2. **Привязка аккаунтов**: VK аккаунт должен быть привязан к существующему админ-аккаунту
3. **Двухфакторная проверка**: для привязки требуется ввод логина и пароля администратора

## Установка и настройка

### 1. Инициализация системы

Выполните скрипт инициализации:
```
http://localhost/init_vk_system.php
```

### 2. Создание VK приложения

1. Перейдите на https://vk.com/apps?act=manage
2. Нажмите "Создать приложение"
3. Выберите тип "Веб-сайт"
4. Заполните данные приложения
5. В настройках укажите:
   - **Базовый домен**: `localhost`
   - **Адрес сайта**: `http://localhost`
   - **Доверенный redirect URI**: `http://localhost/admin/vk_callback.php`

### 3. Настройка конфигурации

Отредактируйте файл `public/admin/vk_config.php`:

```php
define('VK_APP_ID', 'ВАШ_APP_ID');
define('VK_APP_SECRET', 'ВАШ_APP_SECRET');
define('VK_REDIRECT_URI', 'http://localhost/admin/vk_callback.php');
```

## Структура файлов

```
├── vk_oauth_setup.sql          # SQL скрипт для обновления БД
├── public/
│   ├── init_vk_system.php      # Скрипт инициализации
│   └── admin/
│       ├── vk_config.php       # Конфигурация VK OAuth
│       ├── vk_callback.php     # Обработчик callback от VK
│       ├── vk_link_account.php # Страница привязки аккаунта
│       └── login.php           # Обновленная страница входа
```

## Изменения в базе данных

Добавлены новые поля в таблицу `admin_users`:

- `vk_id` (BIGINT) - уникальный ID пользователя ВКонтакте
- `vk_access_token` (VARCHAR) - токен доступа VK API
- `vk_avatar_url` (VARCHAR) - URL аватара пользователя

## Процесс авторизации

### Для нового VK пользователя:

1. Пользователь нажимает "Войти через ВКонтакте"
2. Происходит редирект на VK для авторизации
3. После успешной авторизации VK возвращает пользователя
4. Система проверяет, привязан ли VK ID к существующему админу
5. Если НЕТ - показывается страница привязки аккаунта
6. Пользователь вводит логин и пароль существующего администратора
7. После проверки VK аккаунт привязывается к админ-аккаунту
8. Пользователь авторизуется в системе

### Для уже привязанного VK пользователя:

1. Пользователь нажимает "Войти через ВКонтакте"
2. Происходит редирект на VK для авторизации
3. После успешной авторизации система находит связанный админ-аккаунт
4. Пользователь автоматически авторизуется в админ-панели

## Безопасность

### ✅ Реализованные меры безопасности:

- **Ограниченная регистрация**: новые пользователи НЕ могут создавать аккаунты через VK
- **Привязка к существующим админам**: VK можно привязать только к уже существующим администраторам
- **Двухфакторная проверка**: для привязки требуется знание логина и пароля администратора
- **Уникальность VK ID**: один VK аккаунт может быть привязан только к одному администратору
- **Проверка токенов**: валидация токенов доступа VK API
- **Безопасные сессии**: использование PHP сессий для хранения состояния авторизации

### ⚠️ Рекомендации по безопасности:

1. **Переменные окружения**: в продакшене храните VK_APP_SECRET в переменных окружения
2. **HTTPS**: используйте HTTPS для продакшен-среды
3. **Валидация домена**: настройте правильный домен в VK приложении
4. **Логирование**: добавьте логирование попыток авторизации
5. **Ограничение по IP**: рассмотрите ограничение доступа по IP адресам

## Тестирование

### Предустановленные администраторы:

- **Админ**: логин `admin`, пароль `admin123`
- **Пользователь**: логин `user`, пароль `user123`

### Сценарии тестирования:

1. **Привязка VK к админу**:
   - Войдите через VK
   - Введите данные администратора (admin/admin123)
   - Проверьте успешную авторизацию

2. **Повторный вход через VK**:
   - Выйдите из системы
   - Войдите через VK снова
   - Проверьте автоматическую авторизацию

3. **Попытка привязки к несуществующему пользователю**:
   - Войдите через VK с новым аккаунтом
   - Введите неверные данные администратора
   - Проверьте отображение ошибки

## Устранение неполадок

### Ошибка "Invalid redirect_uri"
- Проверьте настройки VK приложения
- Убедитесь, что redirect_uri точно совпадает с настройками

### Ошибка "Invalid client_secret"
- Проверьте правильность VK_APP_SECRET в vk_config.php
- Убедитесь, что используете Secret Key, а не Service Key

### Ошибка "Access denied"
- Проверьте права доступа VK приложения
- Убедитесь, что запрашиваете только необходимые разрешения

### VK аккаунт не привязывается
- Проверьте подключение к базе данных
- Убедитесь, что выполнен vk_oauth_setup.sql
- Проверьте права пользователя БД на изменение таблиц

## API Reference

### Функции в vk_config.php:

- `getVkAuthUrl()` - получение URL для авторизации VK
- `getVkAccessToken($code)` - получение токена доступа по коду
- `getVkUserInfo($access_token, $user_id)` - получение информации о пользователе

### Сессионные переменные:

- `$_SESSION['admin_logged_in']` - флаг авторизации
- `$_SESSION['vk_authorized']` - флаг VK авторизации
- `$_SESSION['vk_temp_data']` - временные данные VK для привязки

## Поддержка

При возникновении проблем проверьте:

1. Логи веб-сервера
2. Настройки VK приложения
3. Подключение к базе данных
4. Права доступа к файлам

---

**Версия**: 1.0  
**Дата**: 2024  
**Автор**: MoviePortal Team
